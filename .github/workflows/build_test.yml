name: Image building and testing

on: [ workflow_dispatch ]

jobs:
  build_test:
    strategy:
      matrix:
        os: [ubuntu-18.04, windows-2019]
        include:
          - os: ubuntu-18.04
            package_url: https://registrationcenter-download.intel.com/akdlm/irc_nas/16803/l_openvino_toolkit_p_2020.4.287.tgz
            cli_opts: "-os ubuntu18"
          - os: windows-2019
            package_url: https://registrationcenter-download.intel.com/akdlm/irc_nas/16801/w_openvino_toolkit_p_2020.4.287.exe
            cli_opts: "-os winserver2019"
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - name: Code checkout
        uses: actions/checkout@v2
      - name: Setting up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'
      - name: Setting up Python dependencies
        run: python -m pip install -r requirements.txt
      - name: Build and test image
        run: python docker_openvino.py build_test --dist proprietary --source url --install_type install -k cpu ${{ matrix.cli_opts }} --package_url ${{ matrix.package_url }}
      - name: Checking resulting image
        if: ${{ always() }}
        run: docker images

      - name: Collecting artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v2
        with:
          name: logs
          path: |
            logs/
            ./*.html
            ./*.log
